---
title: "VentmindeR"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: cerulean
bibliography: Ventilator_Dashboard_Library.bib
resource_files:
- Ventilator_Dashboard_Library.bib
---

```{r global, include=FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
library(tidyverse)
library(shiny)
library(ggrepel)
library(citr)
library(grid)
library(kableExtra)
library(citr)
library(styler)
library(flexdashboard)
library(flextable)
```

<style>
  .white-box {
    background-color: white;
  }
</style>

```{css set_up_rainbow_effect, echo = FALSE}

.rainbow {
  background-image: -webkit-gradient( linear, left top, right top, color-stop(0, #f22), color-stop(0.15, #f2f), color-stop(0.3, #22f), color-stop(0.45, #2ff), color-stop(0.6, #2f2),color-stop(0.75, #2f2), color-stop(0.9, #ff2), color-stop(1, #f22) );
  background-image: gradient( linear, left top, right top, color-stop(0, #f22), color-stop(0.15, #f2f), color-stop(0.3, #22f), color-stop(0.45, #2ff), color-stop(0.6, #2f2),color-stop(0.75, #2f2), color-stop(0.9, #ff2), color-stop(1, #f22) );
  color:transparent;
  -webkit-background-clip: text;
  background-clip: text;
}
```

# Introduction {.white-box}

**Welcome:**

Welcome to **VentmindeR** (version 2.2, updated 21 August, 2020) a free, online, mobile-friendly, ventilator calculator. This tool was designed for use by clinicians experienced with ventilator management to facilitate rapid bedside calculations. It is **not** a substitute for clinical experience. A list of supporting papers can be found under the _References_ section.

**About Each Calculator:**

*Rate Change* is for use in adjusting ventilator rate based on current and desired blood gas values. It assumes an inverse linear relationship between rate and pCO2, which is **only** true if you are not simultaneously adjusting tidal volume. This calculator assumes a patient is not breathing above their set rate.

*Rate/Volume Change * is for use in adjusting ventilator rate and tidal volume based on current and desired blood gas values. It assumes an inverse linear relationship between minute ventilation and pCO2. This, by definition, assumes that the patient's dead space fraction is constant. **Please note** that changes in dead space fraction after volume adjustments may occur. This calculator assumes a patient is not breathing above their set rate.

*Compliance & Resistance* is for use to calculate a patient's compliance, resistance, and (inspiratory) time constant. It is designed to be used in **constant-flow (square-wave), volume control mode**. This calculator assumes a passive patient (it does not account for $P_{mus}$, or effort exerted by the patient).

*Time Constant* is for use in obtaining an instantaneous time constant from a patient's flow and volume scalars in any mode during passive exhalation. It is recommended that you obtain values from several different points on the exhalation curve, or across multiple breaths, to increase accuracy. Again, this calculator assumes that exhalation is **passive** (exponential decay) and cannot account for an actively exhaling patient.

*P/F & OI* is for use in determining a patient's measures of oxygenation obtained from an arterial blood gas (P/F ratio and oxygenation index), or pulse oximetry (S/F ratio and oxygen saturation index). If a value for PEEP is provided, it will also plot the patient's FiO2 (%) and PEEP in comparison to the ARDSnet recommendations.

*Qp:Qs* is for use in determining the ratio of pulmonary to systemic blood flow in congenital heart disease patients with obligatory 1:1 mixing lesions. If hemoglobin is provided, it will also calculate the oxygen content of a patient's blood. If $P_{a}O_{2}$ is provided, it will also plot the patient's oxygen saturation relative to their partial pressure of oxygen to analyze shift.

**Source Code:**

Medical tools should be free and transparent. The source code for this calculator is publicly available at: https://github.com/drjonpelly/VentmindeR. You are free to copy, modify, and/or distribute this code under two conditions: 1) the product you make is free for others to use (you don't sell it), and 2) you cite the original app (because I worked hard on it).

**About the Author:**

[Jonathan Pelletier](https://twitter.com/drjonpelly) is a fellow in Pediatric Critical Care Medicine. He has interests in data science and using machine learning to assist clinical decision making. When not slaving away at a computer, he enjoys cycling, hiking, and spending time with his family. 

**Plain Language Disclaimer:**

Hey there, UseR, someone’s life depends on what you’re doing here. *Manage that ventilator with the same reverence and care with which you would pack a parachute.* This app makes some assumptions about you, the UseR. It assumes that you’re a trained medical professional with expertise in ventilator management, and a license to back you up. It also assumes that you know what the values you’re generating mean, and what to do with them. When you use VentmindeR, you explicitly acknowledge 1) that you are a trained medical professional with ventilator expertise and 2) that you will thoughtfully consider the data you’re generating in the context of the human who is depending on you, and **not** blindly follow a calculator. There’s a reason that you spent years and thousands of dollars to learn how to manage a ventilator, and this calculator simply can’t replicate the complex decision-making you need to do on a daily basis. VentmindeR exists to make bedside math faster; it is **not** a substitute for a well-trained clinician.
	
While I’ve tried to incorporate some “sanity check” warnings, you can still manipulate VentmindeR to give you dangerous, or even life-threatening, values. The fact that the rate limit warning fires at 28 breaths/min does **not** mean that your severe asthmatic with a time constant of 2 seconds can tolerate a rate of 27 breaths/min. I simply can’t incorporate warnings that sophisticated without asking you for nearly every value off of the patient’s ventilator, which is just impractical. You agree that **you**, not VentmindeR, own the responsibility for your decisions. You also agree that if a calculator is giving you a concerning or unrealistic value, that you’ll treat it with skepticism and manage the patient according to good clinical medicine. Even if the time constant calculator tells you your patient could tolerate a respiratory rate of 40 breaths/min, that’s probably still a terrible idea unless you have a very specific reason for choosing that approach. Lastly, you acknowledge that VentmindeR and its services don’t guarantee accuracy, and that no one is forcing you to use them. You should consider using these calculators to be **at your own risk**.

Be safe out there. What you do matters.

**Legal Language Disclaimer:**

In using VentmindeR online ventilator calculator, and its associated or services, you, the user, are acknowledging that you are a licensed healthcare professional with expertise in ventilator physiology and management. You further agree that any services provided are provided explicitly without warranty or guarantee of any kind, including guarantees of accuracy. VentmindeR does not provide medical advice, and its goods and services are not intended as medical recommendations. You agree to assume full responsibility for any personal injury, loss, or damages, to yourself and any parties related to medical decisions made after using VentmindeR. You further release and discharge VentmindeR, and its creators, from any injury, loss, or damage that results from using VentmindeR or its services, whether caused by the fault of yourself, VentmindeR, or other third parties. You agree to indemnify and defend VentmindeR, and its creators, against all claims, causes of action, damages, judgments, costs or expenses, including attorney fees and other litigation costs, which may in any way arise from your use of VentmindeR or its services.

You acknowledge that you are under no pressure or duress to use VentmindeR or its services, and that you have been given a reasonable opportunity to review this agreement before using VentmindeR or its services. The invalidity or unenforceability of any provision of this agreement, whether standing alone or as applied to a particular occurrence or circumstance, shall not affect the validity or enforceability of any other provision of this agreement or of any other applications of such provision, as the case may be, and such invalid or unenforceable provision shall be deemed not to be a part of this agreement.

**Colophon:**

VentmindeR was built using [RStudio](https://rstudio.com/products/rstudio/). This server is running `r sessionInfo()$R.version$version.string` on `r sessionInfo()$running`, and the following packages:

```{r colophon_table}
package_names <- unlist(map(sessionInfo()$otherPkgs, ~ .$Package))
package_versions <- unlist(map(sessionInfo()$otherPkgs, ~ .$Version))
package_repository <- unlist(map(sessionInfo()$otherPkgs, ~ .$Repository))

knitr::kable(tibble(package_names, package_versions, package_repository) %>%
  arrange(package_names) %>%
  rename(Package = package_names, Version = package_versions, Source = package_repository)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), fixed_thead = F)

rm(package_names, package_versions, package_repository)
```

# Rate Change

## Input {.sidebar}

```{r rate_inputs}

numericInput(
  inputId = "current_pco2",
  label = "Current pCO2 (mmHg):",
  value = 40,
  min = 0,
  max = 100,
  step = 1
)
numericInput(
  inputId = "current_rate",
  label = "Current Ventilator Rate (breaths/min):",
  value = 20,
  min = 0,
  max = 40,
  step = 1
)
numericInput(
  inputId = "desired_pco2",
  label = "Desired pCO2  (mmHg):",
  value = 40,
  min = 0,
  max = 100,
  step = 1
)
```

## Numeric Output 

### Numeric Result {.white-box}

```{r rate_numeric_result}
output$rate_numeric <- renderText({
  out_result <- paste("Your desired rate is <b>", round(input$current_pco2 * input$current_rate / input$desired_pco2, 0), " breaths/min</b>.", sep = "")
  out_rate_limit_warning <- ifelse(input$current_pco2 * input$current_rate / input$desired_pco2 >= 28,
    paste("<br><br><span style=\"color:red\">WARNING: at this rate, a time constant calculation is recommended to prevent air trapping.</span>"),
    paste("")
  )
  out_integer_warning <- ifelse(!is.integer(input$current_rate),
    paste("<br><br><span style=\"color:red\">WARNING: you entered a rate that is not an integer. Was this intentional?</span>", sep = ""),
    paste("")
  )
  out_co2_integer_warning <- ifelse(!is.integer(input$current_pco2) |
    !is.integer(input$desired_pco2),
  paste("<br><br><span style=\"color:red\">WARNING: you entered at least one CO2 value that is not an integer. Was this intentional?</span>", sep = ""),
  paste("")
  )
  return(paste(out_result, out_rate_limit_warning, out_integer_warning, out_co2_integer_warning))
})

htmlOutput("rate_numeric")
```

### Rationale and Equation {.white-box}

The new ventilator rate is calculated based on the following equation:

$Rate_{Current}*pCO2_{Current} =Rate_{Desired}*pCO2_{Desired}$

Therefore:

$Rate_{Desired} = \frac{Rate_{Current}*pCO2_{Current}}{ pCO2_{Desired}}$

Please note that this relationship assumes that a patient's dead space fraction or $\frac{V_{d}}{V_{t}}$ is constant.

### Graph of pCO2 and Rate {.white-box}

```{r rate_output graphical}
renderPlot({
  current_pco2 <- input$current_pco2
  current_rate <- input$current_rate
  desired_pco2 <- input$desired_pco2
  desired_rate <- current_pco2 * current_rate / desired_pco2

  rate_curve_table <- tibble(seq(10, 40, 1)) %>%
    rename(rate = `seq(10, 40, 1)`) %>%
    mutate(co2 = current_pco2 * current_rate / rate)

  colors <- c(
    "current" = "red",
    "desired" = "blue",
    "20" = "black",
    "60" = "black"
  )
  tribble(
    ~rate, ~co2, ~color_mapping, ~point_name,
    current_rate, current_pco2, "red", "current",
    desired_rate, desired_pco2, "blue", "desired",
  ) %>%
    ggplot(aes(x = rate, y = co2)) +
    geom_point(aes(color = point_name)) +
    geom_line(mapping = aes(rate, co2), data = rate_curve_table) +
    scale_color_manual(values = colors) +
    geom_label_repel(aes(label = point_name)) +
    theme_bw() +
    labs(title = "Current and Predicted CO2", subtitle = "Note: this relationship assumes no change to Vd/Vt.", caption = "Wexler HR, Lok P.\nA simple formula for adjusting arterial carbon dioxide tension.\nCan Anaesth Soc J 1981;28(4):370-2.") +
    xlab("Ventilator Rate (breaths/min)") +
    ylab("Predicted pCO2 (mmHg)") +
    theme(legend.position = "none", plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))
})

rm(colors, current_pco2, current_rate, desired_pco2, desired_rate, rate_curve_table)
```

# Rate/Volume Change

## Inputs {.sidebar}

```{r rate_volume_inputs}

numericInput(
  inputId = "rv_current_pco2",
  label = "Current pCO2 (mmHg):",
  value = 40,
  min = 0,
  max = 100,
  step = 1
)
numericInput(
  inputId = "rv_current_rate",
  label = "Current Ventilator Rate (breaths/min):",
  value = 20,
  min = 0,
  max = 40,
  step = 1
)
numericInput(
  inputId = "rv_current_tv",
  label = "Current Tidal Volume (ml/kg):",
  value = 6,
  min = 0,
  max = 20,
  step = 1
)
numericInput(
  inputId = "rv_desired_pco2",
  label = "Desired pCO2 (mmHg):",
  value = 40,
  min = 0,
  max = 100,
  step = 1
)

selectInput(
  inputId = "rv_desired_set",
  label = "Set Tidal Volume or Rate?",
  choices = list("Set Tidal Volume", "Set Rate")
)

output$input_value_label <- renderText(ifelse(input$rv_desired_set == "Set Tidal Volume", "Desired Tidal Volume (ml/kg):", "Desired Rate (breaths/min):"))

numericInput(
  inputId = "rv_desired_numeric",
  label = textOutput("input_value_label"),
  value = 8,
  min = 0,
  max = 100,
  step = 1
)
```

## Numeric Output 

### Result {.white-box}

```{r show_rv_answer}

output$rv_numeric <- renderText({
  if (input$rv_desired_set == "Set Tidal Volume") {
    desired_rate_rv <- input$rv_current_pco2 * input$rv_current_rate * input$rv_current_tv / input$rv_desired_pco2 / input$rv_desired_numeric
    desired_vt_rv <- input$rv_desired_numeric
    rv_result <- paste("You chose a tidal volume of <b>", input$rv_desired_numeric, " ml/kg</b>, and a target pCO2 of <b>", input$rv_desired_pco2, "mmHg</b>.<br>Based on these settings, your desired rate is: <b>", round(desired_rate_rv, 0), " breaths/min</b>.", sep = "")
  }
  if (input$rv_desired_set == "Set Rate") {
    desired_vt_rv <- input$rv_current_pco2 * input$rv_current_rate * input$rv_current_tv / input$rv_desired_pco2 / input$rv_desired_numeric
    desired_rate_rv <- input$rv_desired_numeric
    rv_result <- paste("You chose a rate of <b>", input$rv_desired_numeric, " breaths/min</b> and a target pCO2 of <b>", input$rv_desired_pco2, " mmHg</b>.<br> Based on these settings, your desired tidal volume is: <b>", round(desired_vt_rv, 1), " ml/kg</b>.", sep = "")
  }
  warning_vt <- case_when(
    desired_vt_rv > 10 ~ paste("<br><br><span style=\"color:red\">WARNING: your target tidal volume exceeds 10 ml/kg. This tidal volume may be associated with volutrauma. Please ensure there are no signs of overdistention on pressure-volume loops.</span>"),
    desired_vt_rv < 4 ~ paste("<br><br><span style=\"color:red\">WARNING: your target tidal volume is less than 4 ml/kg. This tidal volume is low, and may be associated with progressive atelectasis. Please ensure this is not an error.</span>"),
    desired_vt_rv >= 4 & desired_vt_rv <= 10 ~ paste("")
  )
  warning_rate <- case_when(
    desired_rate_rv > 28 ~ paste("<br><br><span style=\"color:red\">WARNING: your target rate exceeds 28 breaths/min. At this rate, a time constant calculation is recommended to prevent air trapping.</span>"),
    desired_rate_rv < 10 ~ paste("<br><br><span style=\"color:red\">WARNING: your target rate is less than 10 breaths/min. This rate is low, and may be associated with progressive atelectasis. Please ensure this is not an error.</span>"),
    desired_rate_rv >= 10 & desired_rate_rv <= 28 ~ paste("")
  )
  warning_integer <- ifelse(is.integer(input$rv_current_pco2) & is.integer(input$rv_current_rate) & is.integer(input$rv_desired_pco2) & is.integer(input$rv_desired_numeric) & is.integer(input$rv_current_tv),
    paste(""),
    paste("<br><br><span style=\"color:red\">WARNING: you have entered non-integer values. Is this intentional?</span>")
  )
  return(paste(rv_result, warning_vt, warning_rate, warning_integer))
})

htmlOutput("rv_numeric")
```

### Rationale and Equations {.white-box}

The new ventilator parameters are calculated based on the following equation:

$Minute Ventilation_{Current}*pCO2_{Current}*\frac{V_d}{V_t}_{Current} =$
$Minute Ventilation_{Desired}*pCO2_{Desired}*\frac{V_d}{V_t}_{AfterChange}$

Therefore, assuming $\frac{V_{d}}{V_{t}}$ does not change after your adjustment:

$Rate_{Current}*TidalVolume_{Current}*pCO2_{Current} =$
$Rate_{Desired}*TidalVolume_{Desired}*pCO2_{Desired}$

**Please note** that this relationship assumes that a patient's dead space fraction or $\frac{V_{d}}{V_{t}}$ is constant. **This may not be true**, particularly after volume adjustments.

## Graphical Output

### Graph of pCO2 and Minute Ventilation {.white-box}

```{r show_rv_plot}
renderPlot({
  current_mv <- input$rv_current_rate * input$rv_current_tv
  desired_mv <- input$rv_current_rate * input$rv_current_tv * input$rv_current_pco2 / input$rv_desired_pco2
  current_pco2 <- input$rv_current_pco2
  desired_pco2 <- input$rv_desired_pco2

  mv_curve_table <- tibble(seq(50, 300, 1)) %>%
    rename(minute_ventilation = `seq(50, 300, 1)`) %>%
    mutate(pco2 = current_mv * current_pco2 / minute_ventilation)

  colors <- c(
    "current" = "red",
    "desired" = "blue"
  )

  tribble(
    ~minute_ventilation, ~pco2, ~point_name,
    current_mv, input$rv_current_pco2, "current",
    desired_mv, input$rv_desired_pco2, "desired"
  ) %>%
    ggplot(aes(x = minute_ventilation, y = pco2)) +
    geom_line(aes(minute_ventilation, pco2), data = mv_curve_table) +
    geom_point(aes(color = point_name)) +
    scale_color_manual(values = colors) +
    geom_label_repel(aes(label = point_name)) +
    theme_bw() +
    labs(title = "Current and Predicted CO2", subtitle = "Note: this relationship assumes no change to Vd/Vt.", caption = "Wexler HR, Lok P.\nA simple formula for adjusting arterial carbon dioxide tension.\nCan Anaesth Soc J 1981;28(4):370-2.") +
    xlab("Minute Ventilation (ml/kg/min)") +
    ylab("Predicted pCO2 (mmHg)") +
    theme(legend.position = "none", plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))
})
```

### Graph of pCO2 and Rate Stratified by Tidal Volume {.white-box}

```{r show_rate_by_vt_plot}
renderPlot({
  if (input$rv_desired_set == "Set Tidal Volume") {
    current_pco2 <- input$rv_current_pco2
    current_rate <- input$rv_current_rate
    current_vt <- input$rv_current_tv
    current_mv <- current_vt * current_rate
    desired_pco2 <- input$rv_desired_pco2
    desired_vt <- input$rv_desired_numeric

    desired_rate <- current_rate * current_vt * current_pco2 / desired_pco2 / desired_vt

    rate_by_vt_curve_table <- tibble(rep(seq(10, 40, 1), 4)) %>%
      rename(rate = `rep(seq(10, 40, 1), 4)`) %>%
      mutate(volume = c(rep(4, 31), rep(6, 31), rep(8, 31), rep(10, 31))) %>%
      mutate(minute_ventilation = rate * volume) %>%
      mutate(pco2 = current_mv * current_pco2 / minute_ventilation) %>%
      mutate(`Tidal Volume (ml/kg)` = factor(volume))

    rate_by_vol_graph <- tribble(
      ~rate, ~pco2, ~point_name,
      current_rate, current_pco2, "current",
      desired_rate, desired_pco2, "desired",
    ) %>%
      ggplot(aes(rate, pco2)) +
      geom_line(aes(rate, pco2, lty = `Tidal Volume (ml/kg)`), data = rate_by_vt_curve_table) +
      geom_point(color = c("red", "blue")) +
      geom_label_repel(aes(label = point_name)) +
      xlab("Rate (breaths/min)") +
      ylab("Predicted pCO2 (mmHg)") +
      theme_bw() +
      theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
      labs(title = "Current and Predicted CO2", subtitle = "Note: this relationship assumes no change to Vd/Vt.", caption = "Wexler HR, Lok P.\nA simple formula for adjusting arterial carbon dioxide tension.\nCan Anaesth Soc J 1981;28(4):370-2.")
  }

  if (input$rv_desired_set == "Set Rate") {
    current_pco2 <- input$rv_current_pco2
    current_rate <- input$rv_current_rate
    current_vt <- input$rv_current_tv
    current_mv <- current_vt * current_rate
    desired_pco2 <- input$rv_desired_pco2
    desired_rate <- input$rv_desired_numeric

    desired_vt <- current_rate * current_vt * current_pco2 / desired_pco2 / desired_rate

    rate_by_vt_curve_table <- tibble(rep(seq(10, 40, 1), 4)) %>%
      rename(rate = `rep(seq(10, 40, 1), 4)`) %>%
      mutate(volume = c(rep(4, 31), rep(6, 31), rep(8, 31), rep(10, 31))) %>%
      mutate(minute_ventilation = rate * volume) %>%
      mutate(pco2 = current_mv * current_pco2 / minute_ventilation) %>%
      mutate(`Tidal Volume (ml/kg)` = factor(volume))

    rate_by_vol_graph <- tribble(
      ~rate, ~pco2, ~point_name,
      current_rate, current_pco2, "current",
      desired_rate, desired_pco2, "desired",
    ) %>%
      ggplot(aes(rate, pco2)) +
      geom_line(aes(rate, pco2, lty = `Tidal Volume (ml/kg)`), data = rate_by_vt_curve_table) +
      geom_point(color = c("red", "blue")) +
      geom_label_repel(aes(label = point_name)) +
      xlab("Rate (breaths/min)") +
      ylab("Predicted pCO2 (mmHg)") +
      theme_bw() +
      theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
      labs(title = "Current and Predicted CO2", subtitle = "Note: this relationship assumes no change to Vd/Vt.", caption = "Wexler HR, Lok P.\nA simple formula for adjusting arterial carbon dioxide tension.\nCan Anaesth Soc J 1981;28(4):370-2.")
  }
  rate_by_vol_graph
})
```

# Compliance & Resistance

## Inputs {.sidebar}

```{r cr_inputs}
numericInput(
  inputId = "cr_vt",
  label = "Current Tidal Volume (ml):",
  value = 100,
  min = 0,
  max = 1000,
  step = 1
)
numericInput(
  inputId = "cr_pip",
  label = "Current PIP (cmH20):",
  value = 15,
  min = 0,
  max = 100,
  step = 1
)
numericInput(
  inputId = "cr_pplat",
  label = "Current Plateau Pressure (cmH20):",
  value = 10,
  min = 0,
  max = 100,
  step = 1
)
numericInput(
  inputId = "cr_peep",
  label = "Current PEEP (cmH20):",
  value = 5,
  min = 0,
  max = 100,
  step = 1
)
numericInput(
  inputId = "cr_itime",
  label = "Current Inspiratory Time (seconds):",
  value = 0.7,
  min = 0,
  max = 10,
  step = 0.01
)
numericInput(
  inputId = "cr_height",
  label = "Patient Height (cm):",
  value = 100,
  min = 0,
  max = 1000,
  step = 1
)
```

## Numeric Results

### Description {.white-box}

Below are the patient's calculated compliance, resistance, _inspiratory_ time constant and maximum safe respiratory rate **assuming** that the inspiratory and expiratory time constants are the same. **Please note** that this assumption may not be valid, especially in patients with obstructive physiology. An expiratory time constant calculation is recommended.

```{r compliance_warning}
output$warning_compliance <- renderText({
  warning_compliance_height <- case_when(
    input$cr_height > 200 ~ paste("<span style=\"color:red\">WARNING: you chose a height of ", input$cr_height, " cm. The average height of adult males and females are 175 cm and 162 cm, respectively. Is this deliberate?</span>"),
    input$cr_height < 40 ~ paste("<span style=\"color:red\">WARNING: you chose a height of ", input$cr_height, " cm. The average height of a term newborn is 50 cm. Is this deliberate?</span>"),
    TRUE ~ paste("")
  )
  warning_compliance_integer <- ifelse(is.integer(input$cr_vt) & is.integer(input$cr_pip) & is.integer(input$cr_pplat) & is.integer(input$cr_peep),
    paste(""),
    paste("<br><br><span style=\"color:red\">WARNING: you have entered non-integer values other than inspiratory time or height. Is this deliberate?</span>")
  )
  return(paste(warning_compliance_height, warning_compliance_integer))
})

htmlOutput("warning_compliance")
```


### Numeric Results {.white-box}

```{r compliance_and_resistance_numeric}
renderTable({
  compliance <- input$cr_vt / 1000 / (input$cr_pplat - input$cr_peep)
  resistance <- (input$cr_pip - input$cr_pplat) / (input$cr_vt / 1000 / input$cr_itime)
  time_constant <- compliance * resistance
  tribble(
    ~Variable, ~Value, ~Units,
    "Static Compliance", round(compliance * 1000, 3), "ml/cmH2O",
    "Resistance", round(resistance, 3), "cmH2O*seconds*l",
    "Inspiratory Time Constant", round(time_constant, 3), "seconds",
    "Minimum Safe Exhalation Time", round(time_constant * 3, 3), "seconds",
    "Inspiratory Time", input$cr_itime, "seconds",
    "Breath Cycle Time", round(input$cr_itime + (time_constant * 3), 3), "seconds",
    "Maximum Safe Respiratory Rate", round(60 / (time_constant * 3 + input$cr_itime), 3), "breaths/min"
  )
})
```

### Rationale and Equations {.white-box}

$Compliance=\frac{\Delta Volume}{\Delta Pressure}=\frac{Tidal Volume}{P_{plat} - PEEP}$

$Resistance=\frac{\Delta Pressure}{Flow}=\frac{PIP-P_{plat}}{Flow}=\frac{PIP-P_{plat}}{\frac{V_{t}}{iTime}}$

$TimeConstant=\tau=Compliance*Resistance$

$Maximum Safe Respiratory Rate=\frac{60}{3\tau+iTime}$

## Graphical Output

### Compliance

```{r compliance_curve}
renderPlot({
  pt_compliance <- input$cr_vt / (input$cr_pplat - input$cr_peep)
  pt_height <- input$cr_height

  tibble(height_m = seq(0.6, 2, 0.05)) %>%
    mutate(boys = exp(1.592 * log(height_m) + 2.927)) %>%
    mutate(girls = exp(2.039 * log(height_m) + 2.858)) %>%
    mutate(height_cm = height_m * 100) %>%
    pivot_longer(cols = c(girls, boys)) %>%
    ggplot(aes(x = height_cm, y = value, lty = factor(name))) +
    geom_line() +
    geom_point(aes(pt_height, pt_compliance), color = "blue") +
    geom_label(aes(x = pt_height, y = pt_compliance), label = "patient", color = "blue", nudge_x = -0.1, nudge_y = 2) +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5), legend.title = element_blank()) +
    labs(title = "Patient Compliance Vs. Normal Compliance Curves", subtitle = "The Normal Compliance Curves are Shown in Black", caption = "Lanteri CJ, Sly PD.\nChanges in respiratory mechanics with age.\nJ Appl Physiol (1985) 1993;74(1):369-78.") +
    xlab("Height (cm)") +
    ylab("Static Compliance (ml/cmH2O)")
})
```

### Resistance

```{r resistance_curve}
renderPlot({
  pt_resistance <- (input$cr_pip - input$cr_pplat) / (input$cr_vt / 1000 / input$cr_itime)
  pt_height <- input$cr_height

  tibble(height_m = seq(0.6, 2, 0.05)) %>%
    mutate(boys = exp(-1.560 * log(height_m) + 3.504)) %>%
    mutate(girls = exp(-1.834 * log(height_m) + 3.607)) %>%
    mutate(height_cm = height_m * 100) %>%
    pivot_longer(cols = c(girls, boys)) %>%
    ggplot(aes(x = height_cm, y = value, lty = factor(name))) +
    geom_line() +
    geom_point(aes(pt_height, pt_resistance), color = "red") +
    geom_label(aes(x = pt_height, y = pt_resistance), label = "patient", color = "red", nudge_x = -0.1, nudge_y = 3) +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5), legend.title = element_blank()) +
    labs(title = "Patient Resistance Vs. Normal Resistance Curves", subtitle = "The Normal Respiratory System Resistance Curves are Shown in Black", caption = "Lanteri CJ, Sly PD.\nChanges in respiratory mechanics with age.\nJ Appl Physiol (1985) 1993;74(1):369-78.") +
    xlab("Height (cm)") +
    ylab("System Resistance (cmH2O*seconds/l)")
})
```

# Time Constant

## Inputs {.sidebar}

```{r tc_inputs}
numericInput(
  inputId = "tc_v_1",
  label = "Tidal Volume #1 (ml):",
  value = 100,
  min = 0,
  max = 1000,
  step = 1
)
numericInput(
  inputId = "tc_flow_1",
  label = "Flow #1 (l/min):",
  value = 10,
  min = 0,
  max = 1000,
  step = 1
)
numericInput(
  inputId = "tc_v_2",
  label = "Tidal Volume #2 (ml):",
  value = 200,
  min = 0,
  max = 1000,
  step = 1
)
numericInput(
  inputId = "tc_flow_2",
  label = "Flow #2 (l/min):",
  value = 21,
  min = 0,
  max = 1000,
  step = 1
)
numericInput(
  inputId = "tc_v_3",
  label = "Tidal Volume #3 (ml):",
  value = 300,
  min = 0,
  max = 1000,
  step = 1
)
numericInput(
  inputId = "tc_flow_3",
  label = "Flow #3 (l/min):",
  value = 29,
  min = 0,
  max = 1000,
  step = 1
)
numericInput(
  inputId = "tc_itime",
  label = "Current Inspiratory Time (seconds):",
  value = 0.5,
  min = 0,
  max = 10,
  step = 0.01
)
```

## Numeric Result

### Description {.white-box}

Below is the patient's calculated _expiratory_ time constant and maximum safe respiratory rate to prevent air trapping. This calculator will use linear regression to average 3 readings, to minimize error caused by rounding on the ventilator. **However**, the regression line should have a near perfect correlation. If the $r^{2}$ value is not at least 0.8, please consider repeating your measurements.

```{r tc_warning}
output$tc_warning <- renderText({
  vol_1 <- input$tc_v_1
  flow_1 <- input$tc_flow_1
  vol_2 <- input$tc_v_2
  flow_2 <- input$tc_flow_2
  vol_3 <- input$tc_v_3
  flow_3 <- input$tc_flow_3
  tc_itime <- input$tc_itime

  tc_1 <- (vol_1 / 1000) / (flow_1 / 60)
  tc_2 <- (vol_2 / 1000) / (flow_2 / 60)
  tc_3 <- (vol_3 / 1000) / (flow_3 / 60)

  tc_regression_r_squared <- summary(lm(tribble(
    ~Volume_l, ~Flow_l_sec,
    vol_1 / 1000, flow_1 / 60,
    vol_2 / 1000, flow_2 / 60,
    vol_3 / 1000, flow_3 / 60,
  )))$adj.r.squared

  if (tc_regression_r_squared == 1) {
    out <- paste("<br><span style=\"color:blue\">CAUTION: The regression line has a</span> <span class=\"rainbow\">perfect correlation</span><span style=\"color:blue\">. This is possible, but surprising, and you should be skeptical of the result. Did you measure on three separate breaths?</span>")
  }

  if (tc_regression_r_squared < 1 & tc_regression_r_squared > 0.8) {
    out <- paste("<br>The regression adjusted r^2 value is: ", round(tc_regression_r_squared, 3), ". This is likely acceptable.", sep = "")
  }
  if (tc_regression_r_squared < 0.8) {
    out <- paste("<br><span style=\"color:red\">WARNING: The regression adjusted r^2 value is: ", round(tc_regression_r_squared, 23), ". This suggests a variable expiratory flow waveform. Possible explantions include secretions, active exhalation, or dynamic airway collapse.</span>", sep = "")
  }
  out
})

htmlOutput("tc_warning")
```

### Numeric Results {.white-box}

```{r show_tc_table}
renderTable({
  vol_1 <- input$tc_v_1
  flow_1 <- input$tc_flow_1
  vol_2 <- input$tc_v_2
  flow_2 <- input$tc_flow_2
  vol_3 <- input$tc_v_3
  flow_3 <- input$tc_flow_3
  tc_itime <- input$tc_itime

  tc_1 <- (vol_1 / 1000) / (flow_1 / 60)
  tc_2 <- (vol_2 / 1000) / (flow_2 / 60)
  tc_3 <- (vol_3 / 1000) / (flow_3 / 60)

  tc_regression_est <- summary(lm(tribble(
    ~Volume_l, ~Flow_l_sec,
    vol_1 / 1000, flow_1 / 60,
    vol_2 / 1000, flow_2 / 60,
    vol_3 / 1000, flow_3 / 60,
  )))$coefficients[2, 1]

  tc_regression_r_squared <- summary(lm(tribble(
    ~Volume_l, ~Flow_l_sec,
    vol_1 / 1000, flow_1 / 60,
    vol_2 / 1000, flow_2 / 60,
    vol_3 / 1000, flow_3 / 60,
  )))$adj.r.squared

  tribble(
    ~Variable, ~Value, ~Units,
    "Regression Time Constant", tc_regression_est, "seconds",
    "Regression Time Constant r^2", tc_regression_r_squared, "",
    "Minimum Safe Exhalation Time", round(tc_regression_est * 3, 2), "seconds",
    "Inspiratory Time", tc_itime, "seconds",
    "Breath Cycle Time", round(tc_itime + (tc_regression_est * 3), 2), "seconds",
    "Maximum Safe Respiratory Rate", round(60 / (tc_regression_est * 3 + tc_itime), 2), "breaths/min"
  )
})
```

### Rationale and Equations {.white-box}

$P_{aw}-P_{mus}=Resistance*Flow+\frac{Volume}{Compliance}+PEEP$

During passive exhalation with unlimited expiratory time, airway pressure falls to zero:

$0=Resistance*Flow+\frac{Volume}{Compliance}$

$\frac{-Volume}{Compliance}=Resistance*Flow$

$\frac{-Volume}{Flow}=Resistance*Compliance=TimeConstant(\tau)$

## Graphical Output

### Time Constant Regression Line

```{r tc_regression_plot}
renderPlot({
  vol_1 <- input$tc_v_1
  flow_1 <- input$tc_flow_1
  vol_2 <- input$tc_v_2
  flow_2 <- input$tc_flow_2
  vol_3 <- input$tc_v_3
  flow_3 <- input$tc_flow_3
  tc_itime <- input$tc_itime

  tc_1 <- (vol_1 / 1000) / (flow_1 / 60)
  tc_2 <- (vol_2 / 1000) / (flow_2 / 60)
  tc_3 <- (vol_3 / 1000) / (flow_3 / 60)

  tc_regression_est <- summary(lm(tribble(
    ~Volume_l, ~Flow_l_sec,
    vol_1 / 1000, flow_1 / 60,
    vol_2 / 1000, flow_2 / 60,
    vol_3 / 1000, flow_3 / 60,
  )))$coefficients[2, 1]

  tc_regression_r_squared <- summary(lm(tribble(
    ~Volume_l, ~Flow_l_sec,
    vol_1 / 1000, flow_1 / 60,
    vol_2 / 1000, flow_2 / 60,
    vol_3 / 1000, flow_3 / 60,
  )))$adj.r.squared

  tribble(
    ~Volume_l, ~Flow_l_sec, ~label,
    vol_1 / 1000, flow_1 / 60, "point #1",
    vol_2 / 1000, flow_2 / 60, "point #2",
    vol_3 / 1000, flow_3 / 60, "point #3"
  ) %>%
    ggplot(aes(Volume_l, Flow_l_sec)) +
    geom_point() +
    geom_smooth(method = "lm", color = "black", se = FALSE, lty = 2) +
    theme_bw() +
    labs(title = "Regression for Time Constant", subtitle = paste("The Estimated Time Constant is: ", round(tc_regression_est, 2), " seconds, with an r^2 of: ", round(tc_regression_r_squared, 2), ".\nThe slope of the line shown is the time constant.", sep = ""), caption = "Please note that this graph expresses volume in liters and\nflow in liters per second to yield a time constant in seconds.") +
    xlab("Volume Remaining (liters)") +
    ylab("Flow (liters/second)") +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
    ggrepel::geom_label_repel(aes(label = label))
})
```

### Graph of Exhalation over Time {.white-box}

```{r exhale_graph}
renderPlot({
  vol_1 <- input$tc_v_1
  flow_1 <- input$tc_flow_1
  vol_2 <- input$tc_v_2
  flow_2 <- input$tc_flow_2
  vol_3 <- input$tc_v_3
  flow_3 <- input$tc_flow_3
  tc_itime <- input$tc_itime

  tc_1 <- (vol_1 / 1000) / (flow_1 / 60)
  tc_2 <- (vol_2 / 1000) / (flow_2 / 60)
  tc_3 <- (vol_3 / 1000) / (flow_3 / 60)

  tc <- summary(lm(tribble(
    ~Volume_l, ~Flow_l_sec,
    vol_1 / 1000, flow_1 / 60,
    vol_2 / 1000, flow_2 / 60,
    vol_3 / 1000, flow_3 / 60,
  )))$coefficients[2, 1]

  tibble(time = seq(0, 10, 0.05)) %>%
    mutate(remaining = exp(-time / tc)) %>%
    ggplot(aes(time, remaining * 100)) +
    geom_line() +
    geom_vline(aes(xintercept = tc * 3), lty = 2, color = "red") +
    geom_vline(aes(xintercept = tc), lty = 2, color = "blue") +
    geom_label(aes(tc * 3 + 0.6, 25), label = paste(round(tc * 3, 2), "seconds\n3 Time Constants\n95% Vt Exhaled"), color = "red") +
    geom_label(aes(tc + 0.6, 75), label = paste(round(tc, 2), "seconds\n1 Time Constant\n37% Vt Exhaled"), color = "blue") +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5)) +
    labs(title = "Percent of Tidal Volume Exhaled over Time") +
    ylab("% of Tidal Volume Remaining") +
    scale_x_continuous(breaks = seq(0, 10, 2), name = "Exhale Time (seconds)")
})
```

### Graph of Exhalation over Time {.white-box .mobile}

```{r exhale_graph_mobile}
renderPlot({
  vol_1 <- input$tc_v_1
  flow_1 <- input$tc_flow_1
  vol_2 <- input$tc_v_2
  flow_2 <- input$tc_flow_2
  vol_3 <- input$tc_v_3
  flow_3 <- input$tc_flow_3
  tc_itime <- input$tc_itime

  tc_1 <- (vol_1 / 1000) / (flow_1 / 60)
  tc_2 <- (vol_2 / 1000) / (flow_2 / 60)
  tc_3 <- (vol_3 / 1000) / (flow_3 / 60)

  tc <- summary(lm(tribble(
    ~Volume_l, ~Flow_l_sec,
    vol_1 / 1000, flow_1 / 60,
    vol_2 / 1000, flow_2 / 60,
    vol_3 / 1000, flow_3 / 60,
  )))$coefficients[2, 1]

  tibble(time = seq(0, 10, 0.05)) %>%
    mutate(remaining = exp(-time / tc)) %>%
    ggplot(aes(time, remaining * 100)) +
    geom_line() +
    geom_vline(aes(xintercept = tc * 3), lty = 2, color = "red") +
    geom_vline(aes(xintercept = tc), lty = 2, color = "blue") +
    geom_label(aes(tc * 3 + 1.7, 25), label = paste(round(tc * 3, 2), "seconds\n3 Time Constants\n95% Vt Exhaled"), color = "red") +
    geom_label(aes(tc + 1.7, 75), label = paste(round(tc, 2), "seconds\n1 Time Constant\n37% Vt Exhaled"), color = "blue") +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5)) +
    labs(title = "Percent of Tidal Volume Exhaled over Time") +
    ylab("% of Tidal Volume Remaining") +
    scale_x_continuous(breaks = seq(0, 10, 2), name = "Exhale Time (seconds)")
})
```

# Vd/Vt

## Inputs {.sidebar}

```{r}
numericInput(
  inputId = "vdvt_paco2",
  label = "PaCO2 (mmHg):",
  value = 40,
  min = 0,
  max = 100,
  step = 1
)
numericInput(
  inputId = "vdvt_peco2",
  label = "End-Tidal CO2 (mmHg)",
  value = 35,
  min = 0,
  max = 100,
  step = 1
)
```

## Outputs

### Result {.white-box}

```{r vd_vt_text}
output$vd_vt <- renderText({
  vd_vt <- (input$vdvt_paco2 - input$vdvt_peco2) / input$vdvt_paco2
  paste("The patient's Vd/Vt is: <b>", round(vd_vt, 2), "</b>.<br><br>Normal Vd/Vt in children was originally found to be approximately 0.33 ± 0.05 in the original 1976 Kerr study, but has been suggested to be lower in more recent studies.", sep = "")
})

htmlOutput("vd_vt")
```

### Rationale and Equation {.white-box}

$\frac{V_{d}}{V_{t}}$ is defined as the ratio of physiologic dead space to tidal volume. It is defined by the following equation. 

$\frac{V_{d}}{V_{t}}=\frac{P_{a}CO_{2}-P_{ET}CO_{2}}{P_{a}CO_{2}}$

**Please note** that because the anatomic (not physiologic) dead space is a fixed value for a given patient (based on the size of the airway, etc.), $\frac{V_{d}}{V_{t}}$ is variable with changes in tidal volume.

# P/F & OI

## Inputs {.sidebar}

```{r pf_oi_inputs}
numericInput(
  inputId = "oi_fio2",
  label = "Current FiO2 (%):",
  value = 30,
  min = 0,
  max = 100,
  step = 1
)

numericInput(
  inputId = "oi_map",
  label = "Current Mean Airway Pressure (cmH2O):",
  value = 8,
  min = 0,
  max = 100,
  step = 1
)
numericInput(
  inputId = "oi_peep",
  label = "Current PEEP (cmH2O):",
  value = 5,
  min = 0,
  max = 100,
  step = 1
)

selectInput(
  inputId = "oi_desired",
  label = "P/F and OI or S/F and OSI?",
  choices = list("P/F and OI", "S/F and OSI")
)

output$oi_pao2_label <- renderText(ifelse(input$oi_desired == "P/F and OI",
                                          paste("Current PaO2 (mmHg):"),
                                          paste("Current SpO2 (%):")))

numericInput(
  inputId = "oi_pao2",
  label = textOutput("oi_pao2_label"),
  value = 100,
  min = 0,
  max = 1000,
  step = 1
)
```

## Outputs

### Numeric Result {.white-box}

```{r oi_numeric_result}
output$pf_oi_calculation <- renderText({
  pf_ratio <- input$oi_pao2 / input$oi_fio2 * 100
  oi_index <- input$oi_fio2 * input$oi_map / input$oi_pao2
  
  numeric_calculation <- case_when(
    input$oi_desired == "P/F and OI" ~ paste("The patient's P/F ratio is <b>", round(pf_ratio, 1), "</b>, and the patient's oxygenation index (OI) is <b>", round(oi_index, 1), "</b>.<br><br>PALICC defines pediatric ARDS as a P/F ratio <300 (mild), 100-199 (moderate), and <100 (severe) or an oxygnation index of ≥4 (mild), ≥8 (moderate), ≥16 (severe). The use of the oxygenation index is preferred.", sep = ""),
    input$oi_desired == "S/F and OSI" & input$oi_pao2 >= 100 ~ paste("<span style=\"color:red\">WARNING: You have selected an oxygen saturation of ≥100%. Thus, it is not possible to calculate an S/F ratio or OSI. Did you mean to enter a PaO2?</span>"),
    input$oi_desired == "S/F and OSI" & input$oi_pao2 < 100 ~ paste("The patient's S/F ratio is <b>", round(pf_ratio, 1), "</b>, and the patient's oxygenation saturation index (OSI) is <b>", round(oi_index, 1), "</b>.<br><br>PALICC defines pediatric ARDS as an S/F ratio <264 or an oxygnation saturation index of ≥5 (mild), ≥7.5 (moderate), ≥12.3 (severe). The use of the oxygenation saturation index is preferred.", sep = "")
  )
  
  integer_warning <- ifelse(is.integer(input$oi_fio2) & is.integer(input$oi_map) & is.integer(input$oi_peep) & is.integer(input$oi_pao2),
                            paste(""),
                            paste("<br><br><span style=\"color:red\">WARNING: you have entered non-integer values. Is this deliberate?"))
  return(paste(numeric_calculation, integer_warning))
})

htmlOutput("pf_oi_calculation")

```

### Rationale and Equations {.white-box}

$\frac{P}{F}Ratio=\frac{P_{a}O2}{F_{i}O2}$

$OI=\frac{F_{i}O2*MAP*100}{P_{a}O2}$

$\frac{S}{F}Ratio=\frac{S_{p}O2}{F_{i}O2}$

$OSI=\frac{F_{i}O2*MAP*100}{S_{p}O2}$

Please note that an S/F ratio and OSI should **only** be calculated when $S_{p}O2<100$%. This is because if $S_{p}O2=100$%, it is impossible to infer a presumed $P_{a}O2$.

### ARDSnet (Adult) PEEP Recommendations {.white-box}

```{r ardsnet_peep_graph}
renderPlot({
  patient_fio2 <- input$oi_fio2
  patient_peep <- input$oi_peep

  tribble(
    ~fio2, ~lower_peep_1, ~lower_peep_2, ~upper_peep_1, ~upper_peep_2,
    30, 5, 5, 5, 14,
    40, 5, 8, 14, 16,
    50, 8, 10, 16, 20,
    60, 10, 10, 20, 20,
    70, 10, 14, 20, 20,
    80, 14, 14, 20, 22,
    90, 14, 18, 22, 22,
    100, 18, 24, 22, 24,
  ) %>%
    ggplot(aes(fio2)) +
    geom_ribbon(aes(ymin = lower_peep_1, ymax = lower_peep_2), color = "blue", fill = "blue", alpha = 0.1) +
    geom_ribbon(aes(ymin = upper_peep_1, ymax = upper_peep_2), color = "red", fill = "red", alpha = 0.1) +
    geom_point(aes(x = patient_fio2, y = patient_peep)) +
    geom_label(aes(x = patient_fio2, y = patient_peep), label = "patient", nudge_y = 3) +
    theme_bw() +
    labs(title = "Patient PEEP and FiO2 Compared to ARDSnet", subtitle = "Lower/higher PEEP strategies are in blue/red, respectively.", caption = "ARDSnet.\nNIH NHLBI ARDS Clinical Network Mechanical Ventilation Protocol Summary\n2008.") +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
    xlab("Fio2 (%)") +
    ylab("PEEP (cmH2O)")
})
```

### ARDSnet PEEP Recommendations {.mobile}

```{r ardsnet_peep_graph_mobile}
renderPlot({
  patient_fio2 <- input$oi_fio2
  patient_peep <- input$oi_peep

  tribble(
    ~fio2, ~lower_peep_1, ~lower_peep_2, ~upper_peep_1, ~upper_peep_2,
    30, 5, 5, 5, 14,
    40, 5, 8, 14, 16,
    50, 8, 10, 16, 20,
    60, 10, 10, 20, 20,
    70, 10, 14, 20, 20,
    80, 14, 14, 20, 22,
    90, 14, 18, 22, 22,
    100, 18, 24, 22, 24,
  ) %>%
    ggplot(aes(fio2)) +
    geom_ribbon(aes(ymin = lower_peep_1, ymax = lower_peep_2), color = "blue", fill = "blue", alpha = 0.1) +
    geom_ribbon(aes(ymin = upper_peep_1, ymax = upper_peep_2), color = "red", fill = "red", alpha = 0.1) +
    geom_point(aes(x = patient_fio2, y = patient_peep)) +
    geom_label(aes(x = patient_fio2, y = patient_peep), label = "patient", nudge_y = 0.8, nudge_x = 5) +
    theme_bw() +
    labs(title = "Patient PEEP and FiO2 Compared to ARDSnet", subtitle = "Lower/higher PEEP strategies are in blue/red, respectively.", caption = "ARDSnet.\nNIH NHLBI ARDS Clinical Network Mechanical Ventilation Protocol Summary\n2008.") +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
    xlab("Fio2 (%)") +
    ylab("PEEP (cmH2O)")
})
```

# Qp:Qs

## Inputs {.sidebar}

```{r qp_qs_inputs}

numericInput(
  inputId = "ao_sat",
  label = "Arterial Oxygen Saturation (%):",
  value = 80,
  min = 0,
  max = 100,
  step = 1
)

numericInput(
  inputId = "svc_sat",
  label = "Mixed Venous Oxygen Saturation (%):",
  value = 60,
  min = 0,
  max = 100,
  step = 1
)

numericInput(
  inputId = "pv_sat",
  label = "Pulmonary Venous Oxygen Saturation (%)",
  value = 100,
  min = 0,
  max = 100,
  step = 1
)

numericInput(
  inputId = "hgb",
  label = "Hemoglobin (mg/dL):",
  value = 12.0,
  min = 0,
  max = 100,
  step = 0.1
)

numericInput(
  inputId = "qp_qs_pao2",
  label = "Partial Pressure of Oxygen (mmHg):",
  value = 40,
  min = 0,
  max = 1000,
  step = 1
)
```

## Outputs

### Numeric Results {.white-box}

```{r qp_qs_numeric_result}
output$qp_qs_result <- renderText({
  qp_qs <- (input$ao_sat - input$svc_sat) / (input$pv_sat - input$ao_sat)
  carrying_capacity <- 1.34 * input$hgb * input$ao_sat / 100 + 0.003 * input$qp_qs_pao2
  numeric_result <- paste("The pulmonary to systemic blood flow ratio (Qp:Qs) is <b>", round(qp_qs, 2), " to 1</b>.<br>", "The patient's blood oxygen content is <b>", round(carrying_capacity, 2), " ml/dL</b>.", sep = "")
  integer_warning <- ifelse(is.integer(input$ao_sat) & is.integer(input$svc_sat) & is.integer(input$pv_sat) & is.integer(input$qp_qs_pao2),
                            paste(""),
                            paste("<br><br><span style=\"color:red\">WARNING: you have entered non-integer values other than hemoglobin. Is this deliberate?"))
  pv_sat_warning <- case_when(input$pv_sat > 100 ~ paste("<br><br><span style=\"color:red\">WARNING: you have entered a pulmonary venous oxygen saturation greater than 100%. This is not physiologically possible."),
                              input$pv_sat < 90 ~ paste("<br><br><span style=\"color:red\">WARNING: you have entered a pulmonary venous oxygen saturation less than 90%. Is this deliberate?"),
                              TRUE ~ paste(""))
  ao_sat_warning <- case_when(input$ao_sat > 100 ~ paste("<br><br><span style=\"color:red\">WARNING: you have entered an aortic oxygen saturation greater than 100%. This is not physiologically possible."),
                              input$ao_sat < 60 ~ paste("<br><br><span style=\"color:red\">WARNING: you have entered an aortic oxygen saturation less than 60%. Is this deliberate?"),
                              TRUE ~ paste(""))
  svc_sat_warning <- case_when(input$svc_sat > 80 ~ paste("<br><br><span style=\"color:red\">WARNING: you have entered a mixed venous aortic oxygen saturation greater than 80%. Is this deliberate?"),
                              input$svc_sat < 40 ~ paste("<br><br><span style=\"color:red\">WARNING: you have entered a mixed venous oxygen saturation less than 40%. Is this deliberate?"),
                              TRUE ~ paste(""))
  hgb_warning <- case_when(input$hgb > 20 ~ paste("<br><br><span style=\"color:red\">WARNING: you have entered a hemoglobin greater than 20 mg/dl. Is this deliberate?"),
                              input$hgb < 5 ~ paste("<br><br><span style=\"color:red\">WARNING: you have entered hemoglobin less than 5 mg/dl. Is this deliberate?"),
                              TRUE ~ paste(""))
    pao2_warning <- case_when(input$qp_qs_pao2 > 300 ~ paste("<br><br><span style=\"color:red\">WARNING: you have entered a PaO2 greater than 300 mmHg. Is this deliberate?"),
                              input$qp_qs_pao2 < 30 ~ paste("<br><br><span style=\"color:red\">WARNING: you have entered a PaO2 less than 30 mmHg. Is this deliberate?"),
                              TRUE ~ paste(""))
  return(paste(numeric_result, integer_warning, ao_sat_warning, svc_sat_warning, pv_sat_warning, hgb_warning, pao2_warning))
})

htmlOutput("qp_qs_result")
```

### Equation and Rationale {.white-box}

In a patient with an obligatory 1:1 mixing lesion (e.g. hypoplastic left heart syndrome with mitral and aortic atresia, as drawn), the $Q_{p}:Q_{s}$ ratio can be calculated by the following equation:

$Q_{p}:Q_{s} = \frac{S_{a}O2-S_{v}O2}{S_{PV}O2-S_{PA}O2}$

**Assuming** that the patient has an obligatory 1:1 mixing lesion (no forward flow across the aortic valve), then the pulmonary artery saturation is the same as the arterial oxygen saturation. In patients with healthy lungs, the pulmonary venous saturation is usually **assumed** to be 100%.

Blood oxygen content is calculated by the following equation:

$C_{a}O_{2}=\frac{1.34*Hemoglobin(\frac{mg}{dL})*S_{p}O_{2}}{100}+0.003*P_{a}O_{2}$

## Graphical Results

### Diagram {.white-box}

```{r qp_qs_graphical_result}

circleFun <- function(center = c(0, 0), diameter = 1, npoints = 100) {
  r <- diameter / 2
  tt <- seq(0, 2 * pi, length.out = npoints)
  xx <- center[1] + r * cos(tt)
  yy <- center[2] + r * sin(tt)
  return(data.frame(x = xx, y = yy))
}

lupv <- circleFun(c(3.75, 3.75), .25, npoints = 100)
llpv <- circleFun(c(3.75, 3.5), .25, npoints = 100)
rupv <- circleFun(c(3.5, 3.75), .25, npoints = 100)
rlpv <- circleFun(c(3.5, 3.5), .25, npoints = 100)


renderPlot({
  svc_sat <- input$svc_sat
  ao_sat <- input$ao_sat
  pv_sat <- input$pv_sat

  tribble(
    ~x, ~y,
    1, 1,
    2, 2,
    3, 3,
    4, 4,
    5, 5,
  ) %>%
    ggplot(aes(x = x, y = y)) +
    geom_rect(aes(xmin = 2, xmax = 3, ymin = 3, ymax = 4), fill = "purple", alpha = 0.1) + # RV
    geom_rect(aes(xmin = 2, xmax = 3, ymin = 2, ymax = 3), fill = "purple", alpha = 0.1) + # RA
    geom_rect(aes(xmin = 2.4, xmax = 2.6, ymin = 4, ymax = 5), fill = "blue", alpha = 0.1) + # SVC
    geom_rect(aes(xmin = 1, xmax = 2, ymin = 3.4, ymax = 3.6), fill = "blue", alpha = 0.1) + # IVC
    geom_rect(aes(xmin = 3, xmax = 4, ymin = 2, ymax = 3), fill = "black", alpha = 0.1) + # LV
    geom_rect(aes(xmin = 3, xmax = 4, ymin = 3, ymax = 4), fill = "purple", alpha = 0.1) + # LA
    geom_rect(aes(xmin = 2.3, xmax = 2.7, ymin = 1, ymax = 2), fill = "purple", alpha = 0.1) + # MPA
    geom_rect(aes(xmin = 3.3, xmax = 3.7, ymin = 1, ymax = 2), fill = "purple", alpha = 0.1) + # Ao
    geom_rect(aes(xmin = 2.7, xmax = 3.3, ymin = 1.4, ymax = 1.6), fill = "purple", alpha = 0.1) + # PDA
    geom_segment(aes(x = 3, y = 4, xend = 3, yend = 3.7)) + # atrial septum top
    geom_segment(aes(x = 3, y = 3.3, xend = 3, yend = 2)) + # atrial septum bottom, ventricular septum
    geom_segment(aes(x = 2.7, y = 3, xend = 4, yend = 3)) + # mitral
    geom_segment(aes(x = 2, y = 3, xend = 2.3, yend = 3)) + # tricuspid
    geom_segment(aes(x = 2.5, y = 2.7, xend = 2.7, yend = 3)) + # tricuspid valve
    geom_segment(aes(x = 2, y = 2, xend = 2, yend = 3.4)) + # right wall bottom
    geom_segment(aes(x = 2, y = 3.6, xend = 2, yend = 4)) + # right wall top
    geom_segment(aes(x = 2, y = 4, xend = 2.4, yend = 4)) + # top wall left
    geom_segment(aes(x = 2.6, y = 4, xend = 4, yend = 4)) + # top wall right
    geom_segment(aes(x = 4, y = 4, xend = 4, yend = 2)) + # left wall
    geom_segment(aes(x = 2, y = 2, xend = 2.3, yend = 2)) + # bottom wall right
    geom_segment(aes(x = 2.7, y = 2, xend = 4, yend = 2)) + # bottom wall left
    geom_segment(aes(x = 2.5, y = 1.7, xend = 2.7, yend = 2)) + # pulmonary valve
    geom_segment(aes(x = 3.75, y = 3.75, xend = 4.25, yend = 4.25)) + # pulmonary vein label
    geom_polygon(data = lupv, aes(x, y), fill = "red", color = "black") + # lupv
    geom_polygon(data = llpv, aes(x, y), fill = "red", color = "black") + # llpv
    geom_polygon(data = rupv, aes(x, y), fill = "red", color = "black") + # rupv
    geom_polygon(data = rlpv, aes(x, y), fill = "red", color = "black") + # rlpv
    geom_segment(aes(x = 3.1, y = 3.5, xend = 2.9, yend = 3.5),
      arrow = arrow(length = unit(0.2, "cm"))
    ) + # ASD arrow
    geom_segment(aes(x = 2.5, y = 3.1, xend = 2.5, yend = 2.9),
      arrow = arrow(length = unit(0.2, "cm"))
    ) + # tricuspid arrow
    geom_segment(aes(x = 2.5, y = 2.1, xend = 2.5, yend = 1.9),
      arrow = arrow(length = unit(0.2, "cm"))
    ) + # pulmonary arrow
    geom_segment(aes(x = 2.9, y = 1.5, xend = 3.1, yend = 1.5),
      arrow = arrow(length = unit(0.2, "cm"))
    ) + # PDA arrow
    geom_segment(aes(x = 2.5, y = 1.5, xend = 2.5, yend = 1.3),
      arrow = arrow(length = unit(0.2, "cm"))
    ) + # MPA arrow
    geom_segment(aes(x = 3.5, y = 1.5, xend = 3.5, yend = 1.3),
      arrow = arrow(length = unit(0.2, "cm"))
    ) + # Ao arrow down
    geom_segment(aes(x = 3.5, y = 1.5, xend = 3.5, yend = 1.7),
      arrow = arrow(length = unit(0.2, "cm"))
    ) + # Ao arrow up
    geom_text(aes(2.2, 4.8), label = "SVC", size = 3) +
    geom_text(aes(1.5, 3.7), label = "IVC", size = 3) +
    geom_text(aes(2.2, 3.8), label = "RA", size = 3) +
    geom_text(aes(2.2, 2.8), label = "RV", size = 3) +
    geom_text(aes(3.2, 3.8), label = "LA", size = 3) +
    geom_text(aes(3.5, 2.8), label = "LV\n(excluded)", size = 3) +
    geom_text(aes(2.1, 1.8), label = "MPA", size = 3) +
    geom_text(aes(3.85, 1.8), label = "Ao", size = 3) +
    geom_text(aes(3, 1.7), label = "PDA", size = 3) +
    geom_text(aes(4.35, 4.35), label = "Pulmonary Veins", size = 3) +
    geom_text(aes(2.2, 4.6), label = paste(svc_sat, "%", sep = ""), size = 3, color = "blue") +
    geom_text(aes(3.9, 1.6), label = paste(ao_sat, "%", sep = ""), size = 3, color = "purple") +
    geom_text(aes(2.1, 1.6), label = paste(ao_sat, "%", sep = ""), size = 3, color = "purple") +
    geom_text(aes(4.6, 4.15), label = paste(pv_sat, "%", sep = ""), size = 3, color = "red") +
    coord_fixed() +
    theme_bw() +
    theme(
      axis.title.x = element_blank(),
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.title.y = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks.y = element_blank()
    )
})
```

### Patient PaO2 and SpO2 Compared to Physiologic {.white-box}

```{r pao2_spo2_curve}

renderPlot({
  patient_pao2 <- input$qp_qs_pao2
  patient_spo2 <- input$ao_sat

  tibble(pao2 = seq(0, 150, 1)) %>%
    mutate(spo2 = ((((pao2^3 + 150 * pao2)^(-1) * 23400) + 1)^-1) * 100) %>%
    ggplot(aes(pao2, spo2)) +
    geom_line(color = "black") +
    geom_point(aes(patient_pao2, patient_spo2), color = "red") +
    geom_label(aes(patient_pao2, patient_spo2), label = "patient", nudge_x = -9, nudge_y = +6) +
    theme_bw() +
    xlab("PaO2 (mmHg)") +
    ylab("Oxygen Saturation (%)") +
    labs(caption = "Severinghaus JW.\nSimple, accurate equations for human blood O2 dissociation computations.\nJ Appl Physiol Respir Environ Exerc Physiol. 1979 Mar;46(3):599-602.") +
    theme(plot.title = element_text(hjust = 0.5))
})
```


# References  {.white-box}

## References

**Acknowledgments:**

Many thanks to all of the beta-testers for VentmindeR. Special thanks to [Jay Rakkar](https://twitter.com/JayRakkar) and [Neil Munjal](https://twitter.com/NeilMunjal).

VentmindeR was greatly facilitated by the information contained in [R for Data Science](https://r4ds.had.co.nz), [Mastering Shiny](https://mastering-shiny.org), [ggplot2: Elegant Graphics for Data Analysis](https://ggplot2-book.org), [Advanced R](https://adv-r.hadley.nz), and [R Markdown: The Definitive Guide](https://bookdown.org/yihui/rmarkdown/).

**References:**

@RN5, @RN8, @RN6, @RN30, @RN11, @RN12, @RN4, @RN14, @RN15, @RN29, @RN19, @RN18, @RN17, @RN16, @RN20, @RN1, @RN21, @RN22, @RN23, @RN3, @RN24, @RN31, @RN25, @RN26, @RN27, @RN28, and @RN2
